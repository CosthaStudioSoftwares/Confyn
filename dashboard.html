<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONFYN - Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Ionicons CDN -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <!-- Chart.js CDN for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen bg-gray-100">
        <!-- Barra de Navegação Lateral -->
        <aside class="w-64 flex-shrink-0 bg-slate-900 text-gray-300 flex flex-col transition-all duration-300">
            <!-- Logo -->
            <div class="h-20 flex items-center justify-center px-4 border-b border-slate-800">
                 <div class="flex items-center gap-3">
                    <ion-icon name="shield-checkmark-outline" class="text-3xl text-orange-500"></ion-icon>
                    <span class="text-white text-2xl font-bold">CONFYN</span>
                </div>
            </div>

            <!-- Menu -->
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-2.5 rounded-lg bg-orange-600 text-white font-semibold shadow-md">
                    <ion-icon name="grid-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Dashboard</span>
                </a>
                <a href="empresas.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="business-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Empresas</span>
                </a>
                <a href="turmas.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="people-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Alunos/Turmas</span>
                </a>
                <a href="financeiro.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="cash-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Financeiro</span>
                </a>
                <a href="colaboradores.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="id-card-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Colaboradores</span>
                </a>
                <a href="estoque.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="cube-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Estoque</span>
                </a>
                <a href="administrativo.html" class="flex items-center px-4 py-2.5 rounded-lg hover:bg-slate-800 transition-colors">
                    <ion-icon name="settings-outline" class="text-xl"></ion-icon>
                    <span class="ml-4">Administrativo</span>
                </a>
            </nav>
        </aside>

        <!-- Conteúdo Principal -->
        <div class="flex-1 flex flex-col">
            <!-- Cabeçalho Superior -->
            <header class="h-20 bg-white border-b flex items-center justify-between px-8">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Dashboard</h1>
                    <p class="text-sm text-gray-500">Visão Geral do Sistema</p>
                </div>
                <div class="flex items-center gap-6">
                    <ion-icon name="notifications-outline" class="text-2xl text-gray-600 cursor-pointer"></ion-icon>
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-300 flex items-center justify-center font-bold text-slate-600" id="user-initials">UN</div>
                        <div>
                            <p class="font-semibold text-sm" id="user-name">Usuário Admin</p>
                            <a href="#" id="logout-button" class="text-xs text-orange-600 hover:underline">Sair</a>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Área de Conteúdo -->
            <main class="flex-1 p-8 overflow-y-auto">
                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                        <div class="bg-blue-100 p-3 rounded-full"><ion-icon name="calendar-outline" class="text-2xl text-blue-500"></ion-icon></div>
                        <div>
                            <p class="text-sm text-gray-500">Próximas Turmas (Mês)</p>
                            <p class="text-2xl font-bold text-gray-800" id="kpi-turmas">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                        <div class="bg-green-100 p-3 rounded-full"><ion-icon name="cash-outline" class="text-2xl text-green-500"></ion-icon></div>
                        <div>
                            <p class="text-sm text-gray-500">Contas a Receber</p>
                            <p class="text-2xl font-bold text-gray-800" id="kpi-receber">R$ 0,00</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                        <div class="bg-yellow-100 p-3 rounded-full"><ion-icon name="people-outline" class="text-2xl text-yellow-500"></ion-icon></div>
                        <div>
                            <p class="text-sm text-gray-500">Novos Alunos (Mês)</p>
                            <p class="text-2xl font-bold text-gray-800" id="kpi-alunos">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm flex items-center gap-4">
                        <div class="bg-red-100 p-3 rounded-full"><ion-icon name="alert-circle-outline" class="text-2xl text-red-500"></ion-icon></div>
                        <div>
                            <p class="text-sm text-gray-500">Certificados a Vencer</p>
                            <p class="text-2xl font-bold text-gray-800" id="kpi-vencer">0</p>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-700 mb-4">Faturamento (Últimos 6 meses)</h3>
                        <canvas id="faturamentoChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm">
                         <h3 class="font-semibold text-gray-700 mb-4">Treinamentos por Tipo</h3>
                         <canvas id="treinamentosChart"></canvas>
                    </div>
                </div>

                <!-- Tabela de Acesso Rápido -->
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <h3 class="font-semibold text-gray-700 mb-4">Agenda da Semana</h3>
                    <table class="w-full text-sm text-left text-gray-600">
                        <thead class="bg-gray-50 text-xs text-gray-700 uppercase tracking-wider">
                            <tr>
                                <th class="p-3">Data</th>
                                <th class="p-3">Curso</th>
                                <th class="p-3">Empresa</th>
                                <th class="p-3">Instrutor</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="agenda-table-body">
                           <tr><td colspan="5" class="text-center p-8">Nenhuma turma agendada para os próximos 7 dias.</td></tr>
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // ====================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDJEFwpP0GuuBugz4KFgzwdJTlhXS3H7w8",
            authDomain: "confyn-47447.firebaseapp.com",
            projectId: "confyn-47447",
            storageBucket: "confyn-47447.firebasestorage.app",
            messagingSenderId: "292650745185",
            appId: "1:292650745185:web:2e1555246eb1b14c115920"
        };
        // ====================================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH & SECURITY ---
        onAuthStateChanged(auth, user => {
            if (user) {
                const userName = user.email.split('@')[0];
                document.getElementById('user-name').textContent = userName;
                document.getElementById('user-initials').textContent = userName.substring(0, 2).toUpperCase();
                loadDashboardData();
            } else {
                window.location.href = 'index.html';
            }
        });
        document.getElementById('logout-button').addEventListener('click', () => signOut(auth));

        // --- DATA LOADING ---
        async function loadDashboardData() {
            try {
                const [turmas, lancamentos, cursos] = await Promise.all([
                    fetchCollection('turmas'),
                    fetchCollection('lancamentos'),
                    fetchCollection('cursos')
                ]);

                updateKPIs(turmas, lancamentos, cursos);
                renderFaturamentoChart(lancamentos);
                renderTreinamentosChart(turmas);
                renderAgenda(turmas);

            } catch (error) {
                console.error("Erro ao carregar dados do dashboard:", error);
            }
        }

        async function fetchCollection(collectionName) {
            const snapshot = await getDocs(collection(db, collectionName));
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        // --- KPIs ---
        function updateKPIs(turmas, lancamentos, cursos) {
            const hoje = new Date();
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

            // 1. Próximas Turmas no Mês
            const turmasNoMes = turmas.filter(t => {
                if (!t.data) return false;
                const dataTurma = t.data.toDate();
                return dataTurma >= primeiroDiaMes && dataTurma <= ultimoDiaMes;
            });
            document.getElementById('kpi-turmas').textContent = turmasNoMes.length;

            // 2. Contas a Receber (Total)
            const aReceber = lancamentos
                .filter(l => l.tipo === 'Receita' && l.status !== 'Paga')
                .reduce((sum, l) => sum + l.valor, 0);
            document.getElementById('kpi-receber').textContent = aReceber.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            // 3. Novos Alunos no Mês
            const novosAlunos = turmasNoMes.reduce((sum, t) => sum + (t.alunos ? t.alunos.length : 0), 0);
            document.getElementById('kpi-alunos').textContent = novosAlunos;

            // 4. Certificados a Vencer (Lógica atualizada)
            const cursosMap = new Map(cursos.map(c => [c.nome, c.validadeMeses]));
            const dataAlerta = new Date();
            dataAlerta.setDate(dataAlerta.getDate() + 30); // Alerta para os que vencem nos próximos 30 dias
            
            const aVencer = turmas.filter(t => {
                if(t.status !== 'Concluída' || !t.data) return false;
                
                const validadeMeses = cursosMap.get(t.cursoNome);
                if (validadeMeses === undefined || validadeMeses <= 0) return false; // Não vence ou não tem validade
                
                const dataTurma = t.data.toDate();
                const dataVencimento = new Date(dataTurma);
                dataVencimento.setMonth(dataVencimento.getMonth() + validadeMeses);

                return dataVencimento > hoje && dataVencimento <= dataAlerta;
            });
             document.getElementById('kpi-vencer').textContent = aVencer.length;
        }
        
        // --- CHARTS ---
        let faturamentoChartInstance = null;
        function renderFaturamentoChart(lancamentos) {
            const labels = [];
            const data = [];
            const hoje = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                labels.push(date.toLocaleString('pt-BR', { month: 'short' }));
                
                const inicioMes = new Date(date.getFullYear(), date.getMonth(), 1);
                const fimMes = new Date(date.getFullYear(), date.getMonth() + 1, 0);

                const faturamentoMes = lancamentos
                    .filter(l => {
                        if (l.tipo !== 'Receita' || l.status !== 'Paga' || !l.vencimento) return false;
                        const dataVencimento = l.vencimento.toDate();
                        return dataVencimento >= inicioMes && dataVencimento <= fimMes;
                    })
                    .reduce((sum, l) => sum + l.valor, 0);
                
                data.push(faturamentoMes);
            }
            
            if (faturamentoChartInstance) faturamentoChartInstance.destroy();
            const ctx = document.getElementById('faturamentoChart').getContext('2d');
            faturamentoChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento',
                        data: data,
                        backgroundColor: 'rgba(249, 115, 22, 0.7)',
                        borderColor: 'rgba(249, 115, 22, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false }}, scales: { y: { beginAtZero: true }}}
            });
        }
        
        let treinamentosChartInstance = null;
        function renderTreinamentosChart(turmas) {
            const turmasConcluidas = turmas.filter(t => t.status === 'Concluída');
            const counts = turmasConcluidas.reduce((acc, t) => {
                acc[t.cursoNome] = (acc[t.cursoNome] || 0) + 1;
                return acc;
            }, {});

            const sortedCursos = Object.entries(counts).sort(([,a],[,b]) => b-a);
            
            const labels = sortedCursos.map(item => item[0]);
            const data = sortedCursos.map(item => item[1]);
            
            if (treinamentosChartInstance) treinamentosChartInstance.destroy();
            const ctx = document.getElementById('treinamentosChart').getContext('2d');
            treinamentosChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(107, 114, 128, 0.8)'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }}}
            });
        }

        // --- AGENDA ---
        function renderAgenda(turmas) {
            const tableBody = document.getElementById('agenda-table-body');
            tableBody.innerHTML = '';
            
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            const seteDiasDepois = new Date();
            seteDiasDepois.setDate(hoje.getDate() + 7);
            
            const turmasDaSemana = turmas
                .filter(t => {
                    if (!t.data) return false;
                    const dataTurma = t.data.toDate();
                    return dataTurma >= hoje && dataTurma <= seteDiasDepois;
                })
                .sort((a,b) => a.data.toDate() - b.data.toDate());

            if (turmasDaSemana.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-8">Nenhuma turma agendada para os próximos 7 dias.</td></tr>`;
                 return;
            }

            turmasDaSemana.forEach(turma => {
                const statusClass = turma.status === 'Agendada' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                tableBody.innerHTML += `
                     <tr class="border-b hover:bg-gray-50">
                        <td class="p-3 font-medium text-gray-900">${turma.data.toDate().toLocaleDateString('pt-BR')}</td>
                        <td class="p-3">${turma.cursoNome}</td>
                        <td class="p-3">${turma.empresaNome}</td>
                        <td class="p-3 text-gray-400">A definir</td>
                        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${turma.status}</span></td>
                    </tr>
                `;
            });
        }
    </script>
</body>
</html>

